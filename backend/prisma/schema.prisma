generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String   @id @default(uuid())
  firebaseUid String?  @unique
  email       String   @unique
  password    String?
  name        String?
  phone       String?
  role        UserRole @default(CUSTOMER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isBlocked   Boolean  @default(false)
  
  // Profile fields
  avatar          String?   // Profile image URL
  dateOfBirth     DateTime? // Birthday for special offers
  gender          String?   // 'male', 'female', 'other'
  
  // Preferences
  favoriteProducts Json?     // Array of favorite product IDs
  dietaryPrefs     String[]  // ['vegetarian', 'halal', 'gluten-free', etc.]
  allergyInfo      String[]  // User allergies
  
  // Loyalty & Gamification
  loyaltyPoints   Int      @default(0)
  totalSpent      Float    @default(0)
  memberSince     DateTime @default(now())
  
  // Relations
  orders        Order[]
  reviews       Review[]
  notifications Notification[]
  addresses     Address[]
  
  // Driver specific fields
  isDriver            Boolean        @default(false)
  driverStatus        String?        // 'available', 'busy', 'offline'
  currentLocation     Json?          // { lat, lng, timestamp }
  vehicleType         String?        // 'bike', 'car', 'scooter'
  vehicleNumber       String?

  @@map("users")
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  imageUrl    String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("categories")
}

model Product {
  id              String              @id @default(uuid())
  name            String
  description     String
  imageUrl        String?
  prepTime        Int
  isActive        Boolean             @default(true)
  categoryId      String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  allergens       String[]
  calories        Int?
  carbs           Float?
  cookingSteps    Json?
  cookingTemp     Int?
  cookingTime     Int?
  difficulty      String?
  fat             Float?
  images          String[]
  ingredients     Json?
  protein         Float?
  recipe          String?
  servings        Int?
  basePrice       Float
  dealItems       DealItem[]
  halfLeftItems   OrderItemHalf[]     @relation("HalfLeft")
  halfRightItems  OrderItemHalf[]     @relation("HalfRight")
  orderItems      OrderItem[]
  ingredientsRel  ProductIngredient[]
  productToppings ProductTopping[]
  variations      ProductVariation[]
  category        Category            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  reviews         Review[]

  @@map("products")
}

model ProductVariation {
  id        String   @id @default(uuid())
  productId String
  size      String
  price     Float
  diameter  Int?
  slices    Int?
  weight    Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, size])
  @@map("product_variations")
}

model Ingredient {
  id          String              @id @default(uuid())
  name        String              @unique
  unit        String
  costPerUnit Float
  stockQty    Float
  minStock    Float               @default(10)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  products    ProductIngredient[]

  @@map("ingredients")
}

model ProductIngredient {
  id           String     @id @default(uuid())
  productId    String
  ingredientId String
  quantity     Float
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, ingredientId])
  @@map("product_ingredients")
}

model Deal {
  id            String       @id @default(uuid())
  title         String
  description   String?
  imageUrl      String?
  discountType  DiscountType
  discountValue Float
  isActive      Boolean      @default(true)
  startsAt      DateTime?
  endsAt        DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  items         DealItem[]

  @@map("deals")
}

model DealItem {
  id        String       @id @default(uuid())
  dealId    String
  productId String
  itemType  DealItemType
  quantity  Int          @default(1)
  deal      Deal         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  product   Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([dealId, productId, itemType])
  @@map("deal_items")
}

model Coupon {
  id            String       @id @default(uuid())
  code          String       @unique
  description   String?
  discountType  DiscountType
  discountValue Float
  isActive      Boolean      @default(true)
  startsAt      DateTime?
  endsAt        DateTime?
  usageLimit    Int?
  perUserLimit  Int?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@map("coupons")
}

model Order {
  id                  String        @id @default(uuid())
  orderNumber         String        @unique
  userId              String
  status              OrderStatus   @default(PENDING)
  totalPrice          Float
  paymentMethod       PaymentMethod
  paymentStatus       PaymentStatus @default(PENDING)
  deliveryAddress     String
  deliveryPhone       String
  deliveryLat         Float?
  deliveryLng         Float?
  driverId            String?
  deliveryLocation    Json?
  driverLocation      Json?
  estimatedTime       Int?
  actualDistance      Float?
  trackingStartedAt   DateTime?
  deliveryStartedAt   DateTime?
  deliveryCompletedAt DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  items               OrderItem[]
  user                User          @relation(fields: [userId], references: [id])
  reviews             Review?

  @@map("orders")
}

model OrderItem {
  id          String             @id @default(uuid())
  orderId     String
  productId   String?
  quantity    Int
  price       Float
  createdAt   DateTime           @default(now())
  size        String?
  variationId String?
  halfHalf    OrderItemHalf?
  toppings    OrderItemTopping[]
  order       Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product?           @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Topping {
  id                String             @id @default(uuid())
  name              String             @unique
  price             Float
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  orderItemToppings OrderItemTopping[]
  productToppings   ProductTopping[]

  @@map("toppings")
}

model ProductTopping {
  id        String  @id @default(uuid())
  productId String
  toppingId String
  isDefault Boolean @default(true)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  topping   Topping @relation(fields: [toppingId], references: [id], onDelete: Cascade)

  @@unique([productId, toppingId])
  @@map("product_toppings")
}

model OrderItemTopping {
  id          String    @id @default(uuid())
  orderItemId String
  toppingId   String
  isRemoved   Boolean   @default(false)
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  topping     Topping   @relation(fields: [toppingId], references: [id], onDelete: Cascade)

  @@unique([orderItemId, toppingId, isRemoved])
  @@map("order_item_toppings")
}

model OrderItemHalf {
  id             String    @id @default(uuid())
  orderItemId    String    @unique
  leftProductId  String
  rightProductId String
  leftProduct    Product   @relation("HalfLeft", fields: [leftProductId], references: [id], onDelete: Cascade)
  orderItem      OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  rightProduct   Product   @relation("HalfRight", fields: [rightProductId], references: [id], onDelete: Cascade)

  @@map("order_item_half")
}

model Review {
  id        String   @id @default(uuid())
  userId    String
  orderId   String   @unique
  productId String?
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product? @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("reviews")
}

enum UserRole {
  CUSTOMER
  ADMIN
  DELIVERY
}

enum DiscountType {
  PERCENT
  FIXED
}

enum DealItemType {
  PIZZA
  DRINK
  SIDE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  OUT_FOR_DELIVERY
  DELIVERING
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// ============================================
// NOTIFICATION MODEL - Ogohlantirishlar
// ============================================
model Notification {
  id        Int      @id @default(autoincrement())
  userId    String
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean  @default(false)
  orderId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@map("Notification")
}

enum NotificationType {
  INFO
  WARNING
  SUCCESS
  ERROR
  ORDER
  ORDER_UPDATE
}

// ============================================
// ADDRESS MODEL - Manzillar
// ============================================
model Address {
  id          String   @id @default(uuid())
  userId      String
  label       String   // 'Uy', 'Ish', 'Boshqa'
  street      String
  building    String?  // Bino raqami
  apartment   String?  // Kvartira
  floor       String?  // Qavat
  entrance    String?  // Kirish
  landmark    String?  // Mo'ljal
  lat         Float?
  lng         Float?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("addresses")
}

// üçï ZOR PIZZA - DATABASE SCHEMA
// Bu fayl database strukturasini belgilaydi

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL - Foydalanuvchilar
// ============================================
model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String // Hashed password (bcrypt)
  name     String
  phone    String?
  role     UserRole @default(CUSTOMER)

  // Relationships
  orders  Order[]
  reviews Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users") // Database'da "users" table nomi
}

enum UserRole {
  CUSTOMER // Oddiy mijoz
  ADMIN // Administrator
}

// ============================================
// CATEGORY MODEL - Kategoriyalar (Pizza, Ichimlik...)
// ============================================
model Category {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  imageUrl    String?
  isActive    Boolean @default(true)

  // Relationships
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

// ============================================
// PRODUCT MODEL - Mahsulotlar (Pitsalar)
// ============================================
model Product {
  id          String  @id @default(uuid())
  name        String
  description String
  price       Float // Narx (so'm)
  imageUrl    String?
  prepTime    Int // Tayyorlanish vaqti (daqiqa)
  isActive    Boolean @default(true)

  // Relationships
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  ingredients ProductIngredient[]
  orderItems  OrderItem[]
  reviews     Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

// ============================================
// INGREDIENT MODEL - Ingredientlar
// ============================================
model Ingredient {
  id          String @id @default(uuid())
  name        String @unique
  unit        String // kg, litr, dona
  costPerUnit Float // Birlik narxi
  stockQty    Float // Omborda miqdor
  minStock    Float  @default(10) // Minimal stock (ogohlantirish uchun)

  // Relationships
  products ProductIngredient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ingredients")
}

// ============================================
// PRODUCT-INGREDIENT RELATION - Ko'pdan-ko'pga bog'lanish
// ============================================
model ProductIngredient {
  id String @id @default(uuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  quantity Float // Kerakli miqdor

  @@unique([productId, ingredientId]) // Bir mahsulotda bir ingredient faqat bir marta
  @@map("product_ingredients")
}

// ============================================
// ORDER MODEL - Buyurtmalar
// ============================================
model Order {
  id          String @id @default(uuid())
  orderNumber String @unique // #001, #002... (user-friendly)

  // Customer info
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Order details
  status        OrderStatus   @default(PENDING)
  totalPrice    Float
  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(PENDING)

  // Delivery info
  deliveryAddress String
  deliveryPhone   String
  deliveryLat     Float? // GPS koordinata
  deliveryLng     Float?

  estimatedTime Int? // Taxminiy yetkazish vaqti (daqiqa)

  // Relationships
  items   OrderItem[]
  reviews Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("orders")
}

enum OrderStatus {
  PENDING // Kutilmoqda
  CONFIRMED // Tasdiqlangan
  PREPARING // Tayyorlanmoqda
  READY // Tayyor
  DELIVERING // Yetkazilmoqda
  DELIVERED // Yetkazildi
  CANCELLED // Bekor qilindi
}

enum PaymentMethod {
  CASH // Naqd pul
  CARD // Karta (Stripe)
}

enum PaymentStatus {
  PENDING // Kutilmoqda
  PAID // To'langan
  FAILED // Xatolik
  REFUNDED // Qaytarilgan
}

// ============================================
// ORDER ITEM MODEL - Buyurtma elementlari
// ============================================
model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int // Nechta
  price    Float // O'sha paytdagi narx (tarih uchun)

  @@map("order_items")
}

// ============================================
// REVIEW MODEL - Fikr-mulohazalar
// ============================================
model Review {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  orderId String @unique // Har bir buyurtma uchun faqat 1 ta review
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String? // Ixtiyoriy - muayyan mahsulot uchun review
  product   Product? @relation(fields: [productId], references: [id])

  rating  Int // 1-5 yulduz
  comment String?

  createdAt DateTime @default(now())

  @@map("reviews")
}

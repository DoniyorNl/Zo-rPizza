'use client'

import { Button } from '@/components/ui/button'
import { useAuth } from '@/lib/AuthContext'
import { buildApiUrl } from '@/lib/apiBaseUrl'
import type { TrackingResponse } from '@/types/tracking.types'
import { Map, X } from 'lucide-react'
import { useRouter } from 'next/navigation'
import { useEffect, useState } from 'react'

interface TrackingModalProps {
	open: boolean
	onClose: () => void
	orderId: string
	orderNumber?: string
}

export default function TrackingModal({
	open,
	onClose,
	orderId,
	orderNumber = '',
}: TrackingModalProps) {
	const { user } = useAuth()
	const router = useRouter()
	const [data, setData] = useState<TrackingResponse | null>(null)
	const [loading, setLoading] = useState(false)
	const [error, setError] = useState<string | null>(null)

	useEffect(() => {
		if (!open || !user || !orderId) return
		setLoading(true)
		setError(null)
		;(async () => {
			try {
				const token = await user?.getIdToken?.()
				const res = await fetch(buildApiUrl(`/api/tracking/order/${orderId}`), {
					headers: { Authorization: `Bearer ${token}` },
				})
				if (!res.ok) throw new Error('Failed to load')
				const json = await res.json()
				setData(json.data ?? null)
			} catch {
				setError('Kuzatish maâ€™lumoti yuklanmadi')
			} finally {
				setLoading(false)
			}
		})()
	}, [open, orderId, user])

	const formatETA = (minutes: number) => {
		if (minutes < 60) return `${minutes} min`
		const h = Math.floor(minutes / 60)
		const m = minutes % 60
		return `${h}s ${m}min`
	}

	const goToMap = () => {
		onClose()
		router.push(`/tracking/${orderId}`)
	}

	if (!open) return null

	return (
		<div
			className='fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50'
			onClick={onClose}
			role='dialog'
			aria-modal='true'
			aria-label='Buyurtmani kuzatish'
		>
			<div
				className='bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto'
				onClick={e => e.stopPropagation()}
			>
				<div className='flex items-center justify-between p-4 border-b'>
					<h3 className='font-bold text-lg'>
						Kuzatish {orderNumber ? `#${orderNumber}` : orderId.slice(0, 8)}
					</h3>
					<Button variant='ghost' size='icon' onClick={onClose} aria-label='Yopish'>
						<X className='w-5 h-5' />
					</Button>
				</div>

				<div className='p-4 space-y-4'>
					{loading && (
						<div className='flex justify-center py-8'>
							<div className='animate-spin rounded-full h-10 w-10 border-2 border-orange-500 border-t-transparent' />
						</div>
					)}

					{error && <p className='text-red-600 text-sm text-center py-4'>{error}</p>}

					{!loading && data && (
						<>
							{/* Status */}
							<div className='flex items-center justify-between'>
								<span className='text-sm text-gray-600'>Holat</span>
								<span className='font-medium'>
									{statusLabels[data.order.status] ?? data.order.status}
								</span>
							</div>

							{/* Compact visual: progress / ETA */}
							{data.tracking && data.tracking.driverLocation && (
								<>
									<div className='grid grid-cols-2 gap-3'>
										<div className='bg-blue-50 rounded-lg p-3 text-center'>
											<div className='text-xl font-bold text-blue-600'>
												{data.tracking.distance.toFixed(1)} km
											</div>
											<div className='text-xs text-gray-600'>Masofa</div>
										</div>
										<div className='bg-orange-50 rounded-lg p-3 text-center'>
											<div className='text-xl font-bold text-orange-600'>
												{formatETA(data.tracking.eta)}
											</div>
											<div className='text-xs text-gray-600'>Taxminiy vaqt</div>
										</div>
									</div>
									{/* Mini progress bar */}
									<div className='space-y-1'>
										<div className='h-2 bg-gray-200 rounded-full overflow-hidden'>
											<div
												className='h-full bg-gradient-to-r from-orange-500 to-green-500 rounded-full transition-all'
												style={{
													width: `${Math.min(100, Math.max(0, 100 - data.tracking.distance * 15))}%`,
												}}
											/>
										</div>
										<div className='flex justify-between text-xs text-gray-500'>
											<span>ğŸ• Pitsa</span>
											<span>ğŸï¸ Yoâ€˜lda</span>
											<span>ğŸ  Yetkazildi</span>
										</div>
									</div>
								</>
							)}

							{(!data.tracking || !data.tracking.driverLocation) && (
								<p className='text-sm text-gray-500 text-center py-2'>
									Haydovchi yoâ€˜lga chiqqach, masofa va vaqt shu yerda koâ€˜rinadi.
								</p>
							)}

							{/* Map button */}
							<Button className='w-full bg-orange-600 hover:bg-orange-700' onClick={goToMap}>
								<Map className='w-4 h-4 mr-2' />
								Xaritada koâ€˜rish
							</Button>
						</>
					)}
				</div>
			</div>
		</div>
	)
}

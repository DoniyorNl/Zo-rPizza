# Worklog â€” 2026-02-22

## Bugun bajarilgan asosiy ishlar

- Stripe to'lov tizimi backend va frontendga integratsiya qilindi (test mode).
- Prisma `Order` modeliga `payment_intent_id` maydoni qo'shildi.
- Stripe uchun webhook ishlashi qo'shildi va backendda raw body bilan verifikatsiya yo'lga qo'yildi.
- Checkout oqimi soddalashtirildi: faqat `CASH` va `CARD`.
- `CARD` oqimida Stripe modal checkout joriy qilindi (`PaymentElement`, wallet/karta oqimi).
- To'lov muvaffaqiyatli bo'lganda mavjud success/tracking oqimiga ulash ishlari yakunlandi.

## Backend o'zgarishlari

- `backend/src/controllers/payment.controller.ts` yaratildi:
  - `POST /api/payment/create-intent`
  - `POST /api/payment/webhook`
- `backend/src/routes/payment.routes.ts` yaratildi.
- `backend/src/server.ts` yangilandi:
  - `/api/payment/webhook` raw body bilan ulanish
  - `/api/payment` route ulanishi
- `backend/.env.example` ga quyidagilar qo'shildi:
  - `STRIPE_SECRET_KEY`
  - `STRIPE_WEBHOOK_SECRET`
  - `STRIPE_CURRENCY`
- `backend/package.json` ga `stripe` dependency qo'shildi.

## Prisma o'zgarishlari

- `backend/prisma/schema.prisma`:
  - `Order.payment_intent_id String?`
- Migration qo'shildi:
  - `backend/prisma/migrations/20260222_add_order_payment_intent_id/migration.sql`

## Frontend o'zgarishlari

- `frontend/package.json` ga quyidagilar qo'shildi:
  - `@stripe/stripe-js`
  - `@stripe/react-stripe-js`
- `frontend/.env.example` ga:
  - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`
- `frontend/app/(shop)/checkout/page.tsx`:
  - Checkout to'lov usullari `CASH` + `CARD` ga optimallashtirildi
  - `CARD` tanlanganda Stripe create-intent + modal checkout oqimi
  - Modal UX yaxshilandi (scrollable content, responsive height, sticky actionlar, close confirm)
- `frontend/__tests__/pages/CheckoutPage.test.tsx` mos ravishda yangilandi.

## DX / Docs

- `BUYRUQLAR.md` to'liq copy-friendly formatga o'tkazildi (`bash` code blocklar).
- Stripe local webhook buyrug'i hujjatlashtirildi:
  - `stripe listen --forward-to localhost:5001/api/payment/webhook`

## Tekshiruv

- Frontend checkout testlari ishga tushirildi va muvaffaqiyatli o'tdi:
  - `pnpm --filter frontend test -- CheckoutPage.test.tsx`
